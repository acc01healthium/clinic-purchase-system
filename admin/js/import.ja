/*
  /admin/js/import.js
  CSV å¤§é‡åŒ¯å…¥ï¼ˆæ¯ 50 ç­†ä¸€æ‰¹ï¼‰
*/

const supabaseClient = window.supabaseClient;
const fileInput = document.getElementById("csvFile");
const importBtn = document.getElementById("importBtn");
const logBox = document.getElementById("importLog");

importBtn.addEventListener("click", () => {
  if (!fileInput.files.length) {
    alert("è«‹å…ˆé¸æ“‡ CSV æª”æ¡ˆï¼");
    return;
  }

  Papa.parse(fileInput.files[0], {
    header: true,
    skipEmptyLines: true,
    complete: function (result) {
      processCSV(result.data);
    }
  });
});

async function processCSV(rows) {

  logBox.innerHTML = `ğŸ“¦ å…± ${rows.length} ç­†è³‡æ–™ï¼Œé–‹å§‹åŒ¯å…¥â€¦<br>`;

  const batchSize = 50;
  for (let i = 0; i < rows.length; i += batchSize) {
    const batch = rows.slice(i, i + batchSize).map(r => ({
      name: r.name,
      category: r.category || null,
      spec: r.spec || null,
      unit: r.unit || null,
      description: r.description || null,
      last_price: r.last_price ? Number(r.last_price) : null,
      suggested_price: r.suggested_price ? Number(r.suggested_price) : null,
      is_active: true,
    }));

    const { error } = await supabaseClient.from("products").insert(batch);

    if (error) {
      logBox.innerHTML += `<span style='color:red'>âŒ åŒ¯å…¥å¤±æ•—ï¼š${error.message}</span><br>`;
      return;
    }

    logBox.innerHTML += `âœ” å·²åŒ¯å…¥ ${i + batch.length} / ${rows.length}<br>`;
  }

  logBox.innerHTML += "<br>ğŸ‰ å…¨éƒ¨åŒ¯å…¥å®Œæˆï¼";
}
