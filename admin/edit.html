<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>編輯商品｜康醫採購管理系統</title>

  <link rel="stylesheet" href="../css/admin.css">

  <!-- Supabase 套件 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- 你的專案全域 Supabase Client（一定要 defer） -->
  <script src="../js/supabase.js" defer></script>

  <style>
    /* 簡易美化，避免全部貼左邊 */
    body { font-family: Arial; padding: 20px; }
    .edit-form { max-width: 480px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: bold; }
    input, textarea, select {
      width: 100%; padding: 8px; font-size: 14px;
    }
    .preview-image {
      width: 140px; margin-top: 10px; border: 1px solid #ddd; padding: 4px;
    }
    .form-actions { margin-top: 20px; display: flex; gap: 12px; }
    button { padding: 10px 18px; cursor: pointer; }
    .btn-primary { background: #1976d2; color: white; border: none; }
    .btn-danger { background: #d32f2f; color: white; border: none; }
  </style>
</head>

<body>

<h1>編輯商品</h1>
<button onclick="location.href='index.html'">返回列表</button>

<form id="editForm" class="edit-form">

  <div class="form-group">
    <label>商品圖片</label>
    <input type="file" id="imageFile" accept="image/*">
    <img id="previewImage" class="preview-image" src="">
  </div>

  <div class="form-group">
    <label>商品名稱</label>
    <input type="text" id="name" required>
  </div>

  <div class="form-group">
    <label>分類</label>
    <input type="text" id="category">
  </div>

  <div class="form-group">
    <label>規格</label>
    <input type="text" id="spec">
  </div>

  <div class="form-group">
    <label>單位</label>
    <input type="text" id="unit">
  </div>

  <div class="form-group">
    <label>描述</label>
    <textarea id="description"></textarea>
  </div>

  <div class="form-group">
    <label>售價（last_price）</label>
    <input type="number" id="last_price">
  </div>

  <div class="form-group">
    <label>是否啟用</label>
    <select id="is_active">
      <option value="true">啟用</option>
      <option value="false">停用</option>
    </select>
  </div>

  <div class="form-group">
    <label>圖片網址（image_url）</label>
    <input type="text" id="image_url" readonly>
  </div>

  <div class="form-actions">
    <button type="submit" class="btn-primary">儲存修改</button>
    <button type="button" id="deleteBtn" class="btn-danger">刪除商品</button>
  </div>

</form>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const supabase = window.supabaseClient;

  // 取得 URL 的 id
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get("id");

  if (!productId) {
    alert("找不到商品 ID");
    location.href = "index.html";
    return;
  }

  // 取得所有 input 元素
  const nameEl = document.getElementById("name");
  const categoryEl = document.getElementById("category");
  const specEl = document.getElementById("spec");
  const unitEl = document.getElementById("unit");
  const descEl = document.getElementById("description");
  const priceEl = document.getElementById("last_price");
  const activeEl = document.getElementById("is_active");
  const imgUrlEl = document.getElementById("image_url");
  const imgFileEl = document.getElementById("imageFile");
  const previewEl = document.getElementById("previewImage");

  // ⭐ 載入商品
  async function loadProduct() {
    const { data, error } = await supabase
      .from("products")
      .select("*")
      .eq("id", productId)
      .single();

    if (error) {
      alert("讀取資料失敗：" + error.message);
      return;
    }

    nameEl.value = data.name ?? "";
    categoryEl.value = data.category ?? "";
    specEl.value = data.spec ?? "";
    unitEl.value = data.unit ?? "";
    descEl.value = data.description ?? "";
    priceEl.value = data.last_price ?? "";
    activeEl.value = data.is_active ? "true" : "false";

    imgUrlEl.value = data.image_url ?? "";
    if (data.image_url) previewEl.src = data.image_url;
  }

  loadProduct();

  // ⭐ 預覽圖片
  imgFileEl.addEventListener("change", () => {
    const file = imgFileEl.files[0];
    if (file) previewEl.src = URL.createObjectURL(file);
  });

  // ⭐ 修正版：上傳圖片到 product-images bucket
async function uploadImage(file) {
  if (!file) return null;

  const ext = file.name.split(".").pop();
  const fileName = `product_${productId}_${Date.now()}.${ext}`;

  // ❶ 上傳圖片
  const { error: uploadErr } = await db.storage
    .from("product-images")
    .upload(fileName, file, { upsert: true });

  if (uploadErr) {
    alert("圖片上傳失敗：" + uploadErr.message);
    return null;
  }

  // ❷ 取得公開網址
  const { data } = db.storage
    .from("product-images")
    .getPublicUrl(fileName);

  return data.publicUrl;
}


  // ⭐ 儲存更新
  document.getElementById("editForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    let finalImageUrl = imgUrlEl.value;

    // 有選圖片 → 上傳
    if (imgFileEl.files.length > 0) {
      const uploadedUrl = await uploadImage(imgFileEl.files[0]);
      if (uploadedUrl) finalImageUrl = uploadedUrl;
    }

    const updates = {
      name: nameEl.value.trim(),
      category: categoryEl.value.trim(),
      spec: specEl.value.trim(),
      unit: unitEl.value.trim(),
      description: descEl.value.trim(),
      last_price: Number(priceEl.value),
      is_active: activeEl.value === "true",
      image_url: finalImageUrl,
      last_price_updated_at: new Date().toISOString(),
    };

    const { error } = await supabase
      .from("products")
      .update(updates)
      .eq("id", productId);

    if (error) {
      alert("更新失敗：" + error.message);
      return;
    }

    alert("更新成功！");
    location.href = "index.html";
  });

  // ⭐ 刪除商品
  document.getElementById("deleteBtn").addEventListener("click", async () => {
    if (!confirm("確定刪除？")) return;

    const { error } = await supabase
      .from("products")
      .delete()
      .eq("id", productId);

    if (error) alert("刪除失敗：" + error.message);
    else {
      alert("刪除成功！");
      location.href = "index.html";
    }
  });

});
</script>

</body>
</html>
