<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>åº·é†«æ¡è³¼ç®¡ç†ç³»çµ±ï½œå•†å“åˆ—è¡¨</title>

    <!-- ä½ çš„åˆ—è¡¨é  CSSï¼ˆå¦‚æœä½ åŸæœ¬æœ‰ style.css å¯ä»¥ç•™è‘—ï¼‰ -->
    <link rel="stylesheet" href="./css/style.css" />

   <!-- Supabase JS v2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- å…±ç”¨ Supabase client -->
  <script src="./js/supabase.js?v=4"></script>
  <!-- å‰å°åˆ—è¡¨é‚è¼¯ -->
  <script src="./js/index.js?v=4"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        background: #f5f7fb;
      }

      header {
        background: #1f7ed5;
        color: #fff;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header h1 {
        margin: 0;
        font-size: 20px;
      }

      main {
        max-width: 1080px;
        margin: 24px auto;
        background: #fff;
        padding: 16px 24px 32px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      }

      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .btn-primary {
        background: #1f7ed5;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-primary:hover {
        background: #1760a2;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 14px;
      }

      thead {
        background: #f1f5f9;
      }

      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        white-space: nowrap;
      }

      tbody tr:hover {
        background: #f9fafb;
      }

      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
      }

      .tag-green {
        background: #ecfdf3;
        color: #027a48;
      }

      .tag-gray {
        background: #f3f4f6;
        color: #4b5563;
      }

      .btn-small {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #cbd5e1;
        background: #fff;
        cursor: pointer;
        margin-right: 4px;
      }

      .btn-small:hover {
        background: #e5f0ff;
      }

      .text-right {
        text-align: right;
      }

      .text-center {
        text-align: center;
      }

      .empty {
        text-align: center;
        padding: 24px;
        color: #6b7280;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>åº·é†«æ¡è³¼ç®¡ç†ç³»çµ±ï½œå¾Œå°</h1>
      <div>acc01.healthium@gmail.com</div>
    </header>

    <main>
      <div class="toolbar">
        <h2>å•†å“åˆ—è¡¨</h2>
        <!-- ç›®å‰æ–°å¢å•†å“å…ˆä¿ç•™ï¼Œä¹‹å¾Œä½ è¦å†åš new.html å†æ¥ä¸Š -->
        <button
          type="button"
          class="btn-primary"
          id="btnAddProduct"
        >
          æ–°å¢å•†å“ï¼ˆé ç•™ï¼‰
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>åç¨±</th>
            <th>é¡åˆ¥</th>
            <th>è¦æ ¼</th>
            <th>å–®ä½</th>
            <th class="text-right">å”®åƒ¹</th>
            <th>åƒ¹æ ¼æ›´æ–°æ™‚é–“</th>
            <th class="text-center">ç‹€æ…‹</th>
            <th class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="productTableBody">
          <tr>
            <td class="empty" colspan="8">è¼‰å…¥ä¸­â€¦</td>
          </tr>
        </tbody>
      </table>
    </main>

    <script>
      const supabase = window.supabaseClient;

      const tbody = document.getElementById("productTableBody");
      const btnAdd = document.getElementById("btnAddProduct");

      btnAdd.addEventListener("click", () => {
        alert("æ–°å¢å•†å“åŠŸèƒ½å…ˆä¿ç•™ï¼Œä¹‹å¾Œå†ä¸€èµ·è¦åŠƒé é¢ ğŸ˜Š");
      });

      function formatDateTime(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "-";
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}/${m}/${day} ${hh}:${mm}`;
      }

      function renderRows(products) {
        if (!products || products.length === 0) {
          tbody.innerHTML =
            '<tr><td class="empty" colspan="8">ç›®å‰å°šç„¡å•†å“</td></tr>';
          return;
        }

        tbody.innerHTML = "";

        for (const p of products) {
          const tr = document.createElement("tr");

          tr.innerHTML = `
          <td>${p.name ?? ""}</td>
          <td>${p.category ?? ""}</td>
          <td>${p.spec ?? ""}</td>
          <td>${p.unit ?? ""}</td>
          <td class="text-right">NT$ ${p.last_price ?? 0}</td>
          <td>${formatDateTime(p.last_price_updated_at)}</td>
          <td class="text-center">
            <span class="tag ${
              p.is_active ? "tag-green" : "tag-gray"
            }">${p.is_active ? "å•Ÿç”¨" : "åœç”¨"}</span>
          </td>
          <td class="text-center">
            <button class="btn-small btn-edit" data-id="${p.id}">ç·¨è¼¯</button>
          </td>
        `;

          tbody.appendChild(tr);
        }

        // ç¶å®šç·¨è¼¯æŒ‰éˆ•
        tbody.querySelectorAll(".btn-edit").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (!id) return;
            location.href = `./admin/edit.html?id=${encodeURIComponent(id)}`;
          });
        });
      }

      async function loadProducts() {
        tbody.innerHTML =
          '<tr><td class="empty" colspan="8">è¼‰å…¥ä¸­â€¦</td></tr>';

        const { data, error } = await supabase
          .from("products")
          .select("*")
          .order("id", { ascending: true });

        if (error) {
          console.error("è¼‰å…¥å•†å“å¤±æ•—ï¼š", error);
          tbody.innerHTML =
            '<tr><td class="empty" colspan="8">è¼‰å…¥å¤±æ•—ï¼š' +
            error.message +
            "</td></tr>";
          return;
        }

        renderRows(data);
      }

      document.addEventListener("DOMContentLoaded", loadProducts);
    </script>
  </body>
</html>
